{% extends "blog/layout.html" %}
{% load bootstrap3 %}

{% block extra_body %}
    <script>
        $(function(){

            //언더스코어js 로직
            var raw_template = $('#comment-template').html(); //문자열로 내용을 다가져온다
            var tpl = _.template(raw_template); // 가져온 문자열로 언더스코어js 템플릿 생성

            $('#comment-form').submit(function(e){
                e.preventDefault();
                
                var $form = $(this);
                
                var $submit = $form.find('[type=submit]'); //버튼 중복클릭 방지
                $submit.prop('disabled', true);

                var url = $form.attr('action');
                var data = $form.serialize(); //url ecoded된 문자열데이타 "csrflskdfjkjk=13lkjfl & message=입력값"
    
                    $.post(url, data)
                    .done(function(obj){
                        console.log("-----done-------")
                        console.log(obj);

                        if (obj.is_success === false) {
                            alert(obj.message);
                        }
                        else {
                            $('#comment-list').prepend(tpl(obj)); 
                            $form[0].reset(); //[form#comment-form] 폼태그리셋
                        }
                    })
                    .fail(function(xhr, textStatus, error){
                        alert('failed: ' + error);
                    })
                    .always(function() {
                        $submit.prop('disabled', false);
                    });           
            });

            $(document).on('click', '.ajax-post-confirm', function(e){
                e.preventDefault();
                
                var url = $(this).attr('href');
                var target_id = $(this).data('target-id');
                var message = $(this).data('message');

                if (confirm(message)) {
                    $.post(url)
                        .done(function(){
                            $('#' + target_id).remove();
                        })
                        .fail(function(xhr, textStatus, error){
                            alert('failed : ' + error);
                        });
                }
            });
        });
    </script>
{% endblock %}


{% block content %}

<div class="container">
    <div class="row">
        <div class="col-sm-12">
            <h1>{{ post.title }}</h1>
            
            {{ post.content | linebreaks }}
            
            <hr/>
            
            <form id="comment-form" action="{% url "blog:comment_new" post.pk %}" method="post"> <!--detail에서 폼을 작성하였지만 다른 url(comment_new)에서 처리를 해줘야함으로 action값을 줌-->
                {% csrf_token %}
                {% bootstrap_form comment_form %}
                <input type="submit" class="btn btn-primary btn-block" />        
            </form>
            
            {# <a href="{% url "blog:comment_new" post.pk %}" class="btn btn-primary btn-block">댓글쓰기</a> #}

            <ul id="comment-list">
            {% for comment in post.comment_set.all %}
                <li id="comment-{{ comment.pk }}"> <!-- HTML5에서는 커스텀 data 속성을 지원한다. -->
                    {{ comment.message }}
                    &dash;
                    <a href="{% url "blog:comment_edit" post.pk comment.pk %}">
                        <small>{{ comment.updated_at }}</small>
                    </a>
                    
                    <a href="{% url "blog:comment_delete" post.pk comment.pk %}"
                        class="ajax-post-confirm"
                        data-target-id="comment-{{ comment.pk }}"
                        data-message="정말 삭제하시겠습니까?">
                        <small>삭제</small>
                    </a>
                </li>
            {% endfor %}
            </ul>
            
            <hr/>
            <a href="{% url "blog:index" %}" class="btn btn-primary">목록</a>
            <a href="{% url "blog:post_edit" post.pk %}" class="btn btn-primary">수정</a>
            <a href="{% url "blog:post_delete" post.pk %}" class="btn btn-danger">삭제</a> 
        </div>
    </div>
</div>


<!--언더스코어 js로 댓글에 끼워넣을 코드-->
<script type="text/x-template" id="comment-template">
    <li id="comment-<%= id %>">
        <%= message %>
        &dash;
        <a href="<%= edit_url %>">
            <small><%= updated_at %></small>
        </a>
        <a href="<%= delete_url %>"
            class="ajax-post-confirm"
            data-target-id="comment-<%= id %>"
            data-message="정말 삭제하시겠습니까?">
            <small>삭제</small>
        </a>
    </li>
</script>

{% endblock %}